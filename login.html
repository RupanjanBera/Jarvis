<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>J.A.R.V.I.S. // Access Control</title>
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;500;600&display=swap" rel="stylesheet">
  
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root { 
      --primary: #00f3ff; 
      --primary-glow: rgba(0, 243, 255, 0.4);
      --bg-dark: #050505; 
      --glass-panel: rgba(15, 15, 15, 0.85); /* Darker glass for better contrast */
      --input-bg: #000000;
      --text-main: #ffffff;
      --text-muted: #888888;
      --border-color: rgba(255, 255, 255, 0.15);
      --error: #ff3333;
      --success: #00ff88;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg-dark);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Rajdhani', sans-serif;
      overflow: hidden;
      position: relative;
    }

    /* Animated Grid Background */
    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: -2;
    }
    
    /* Vignette Effect */
    body::after {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at center, transparent 0%, #000 90%);
      z-index: -1;
    }

    /* GLASS CARD CONTAINER */
    .login-card {
      width: 100%;
      max-width: 420px;
      background: var(--glass-panel);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      position: relative;
      overflow: hidden;
    }

    /* Top Accent Line */
    .login-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      box-shadow: 0 0 15px var(--primary);
    }

    /* HEADER STYLES */
    .header { text-align: center; margin-bottom: 25px; }
    
    .logo-container {
      width: 60px; height: 60px;
      margin: 0 auto 15px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px var(--primary-glow), inset 0 0 10px var(--primary-glow);
      background: rgba(0,0,0,0.5);
    }
    
    .logo-icon { font-size: 32px; color: var(--primary); }
    
    h1 { 
      font-family: 'Orbitron', sans-serif; 
      font-size: 26px; 
      letter-spacing: 4px; 
      color: #fff; 
      text-transform: uppercase; 
      margin-bottom: 5px;
      text-shadow: 0 0 10px var(--primary-glow);
    }
    
    .subtitle { 
      color: var(--text-muted); 
      font-size: 11px; 
      letter-spacing: 2px; 
      text-transform: uppercase; 
      font-weight: 600; 
    }

    /* INPUT STYLES - High Visibility */
    .input-wrapper { margin-bottom: 15px; position: relative; }
    
    input {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid #333;
      padding: 14px 15px;
      border-radius: 6px;
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      font-size: 16px;
      font-weight: 600;
      outline: none;
      transition: all 0.3s ease;
    }

    /* Placeholder Visibility */
    input::placeholder {
      color: #666 !important; 
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      opacity: 1; 
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.15);
      background: #0a0a0a;
    }

    /* BUTTONS */
    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, rgba(0,243,255,0.1) 0%, rgba(0,243,255,0.2) 100%);
      border: 1px solid var(--primary);
      border-radius: 6px;
      color: var(--primary);
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      font-weight: bold;
      text-shadow: 0 0 5px var(--primary-glow);
    }

    .btn-primary:hover {
      background: var(--primary);
      color: #000;
      box-shadow: 0 0 25px var(--primary-glow);
      text-shadow: none;
    }

    .btn-secondary {
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      cursor: pointer;
      margin-top: 15px;
      transition: 0.3s;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    .btn-secondary:hover { color: #fff; text-shadow: 0 0 8px #fff; }

    /* DIVIDER */
    .divider {
      display: flex;
      align-items: center;
      gap: 15px;
      color: #555;
      font-size: 10px;
      letter-spacing: 1px;
      margin: 20px 0;
      font-family: 'Orbitron';
    }
    .line { flex: 1; height: 1px; background: #333; }

    /* GOOGLE WRAPPER */
    .google-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-bottom: 5px;
    }
    .g_id_signin iframe { margin: 0 auto !important; }
    
    /* Animations */
    .view { display: none; animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .view.active { display: block; }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Status Messages */
    .status-msg {
      text-align: center;
      font-size: 12px;
      margin-top: 15px;
      font-weight: 600;
      min-height: 20px;
      letter-spacing: 0.5px;
    }
    .text-error { color: var(--error); text-shadow: 0 0 10px rgba(255, 51, 51, 0.3); }
    .text-success { color: var(--success); text-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }

    .flex-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    
    /* Guest Button */
    .btn-guest {
        width: 100%;
        margin-top: 10px;
        padding: 10px;
        background: transparent;
        border: 1px dashed #444;
        color: #666;
        font-family: 'Orbitron';
        font-size: 10px;
        cursor: pointer;
        transition: 0.3s;
    }
    .btn-guest:hover { border-color: var(--text-muted); color: #fff; }

  </style>
</head>
<body>

  <div class="login-card">
    
    <div class="header">
      <div class="logo-container">
        <span class="material-icons-round logo-icon">fingerprint</span>
      </div>
      <h1>J.A.R.V.I.S.</h1>
      <div class="subtitle">System Identity Verification</div>
    </div>

    <div id="view-login" class="view active">
      
      <div id="g_id_onload"
           data-client_id="971723044178-n91t8i15nf9kgj4lj57kmst9lk3p8cii.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false"
           data-theme="filled_black">
      </div>
      <div class="google-wrapper">
        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="filled_black"
             data-text="continue_with"
             data-size="large"
             data-logo_alignment="left"
             data-width="320">
        </div>
      </div>

      <div class="divider">
        <div class="line"></div> OR <div class="line"></div>
      </div>

      <div class="input-wrapper">
        <input type="email" id="l_email" placeholder="Email Address">
      </div>
      <div class="input-wrapper">
        <input type="password" id="l_pass" placeholder="Password">
      </div>

      <button class="btn-primary" onclick="doLogin()">Initialize Session</button>
      <button class="btn-guest" onclick="handleGuestMode()">// ACCESS GUEST MODE</button>

      <div class="flex-row">
        <button class="btn-secondary" onclick="switchView('register')">Create ID</button>
        <button class="btn-secondary" onclick="switchView('forgot')">Lost Access?</button>
      </div>
    </div>

    <div id="view-register" class="view">
      <div class="subtitle" style="text-align:center; margin-bottom:20px; color:#fff;">New User Registration</div>
      
      <div class="input-wrapper"><input type="text" id="r_name" placeholder="Full Name"></div>
      <div class="input-wrapper"><input type="email" id="r_email" placeholder="Email Address"></div>
      <div class="input-wrapper"><input type="password" id="r_pass" placeholder="Create Password"></div>
      
      <button class="btn-primary" onclick="doRegister()">Create Record</button>
      <button class="btn-secondary" style="width:100%" onclick="switchView('login')">Return to Login</button>
    </div>

    <div id="view-forgot" class="view">
      <div class="subtitle" style="text-align:center; margin-bottom:20px; color:#fff;">Recovery Protocol</div>
      
      <div class="input-wrapper"><input type="email" id="f_email" placeholder="Registered Email"></div>
      
      <button class="btn-primary" onclick="requestReset()">Send Reset Code</button>
      <button class="btn-secondary" style="width:100%" onclick="switchView('login')">Cancel</button>
    </div>

    <div id="view-reset" class="view">
      <div class="subtitle" style="text-align:center; margin-bottom:20px; color:#fff;">Identity Verification</div>
      
      <div class="input-wrapper">
        <input type="text" id="rs_code" placeholder="6-Digit Code" maxlength="6" style="text-align:center; letter-spacing:5px; font-weight:bold;">
      </div>
      <div class="input-wrapper">
        <input type="password" id="rs_pass" placeholder="New Password">
      </div>
      
      <button class="btn-primary" onclick="confirmReset()">Update Credentials</button>
    </div>

    <div id="status-msg" class="status-msg"></div>

  </div>

  <script>
    // ==========================================================
    // 1. SYSTEM CONFIGURATION
    // ==========================================================
    
    // REPLACE THIS with your actual Ngrok URL
    const API_URL = "https://0e69bffe8fcf.ngrok-free.app";
    
    // The main chatbot file
    const MAIN_APP_URL = "index.html"; 

    // CHECK SESSION ON LOAD (Logic from your original file)
    // If a user is already verified, we skip the login screen entirely.
    if(localStorage.getItem('jarvis_role')) {
      window.location.href = MAIN_APP_URL; 
    }

    // ==========================================================
    // 2. HELPER FUNCTIONS
    // ==========================================================
    function switchView(viewName) {
      document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
      document.getElementById('view-' + viewName).classList.add('active');
      document.getElementById('status-msg').innerText = "";
    }

    function showMsg(text, type='neutral') {
      const el = document.getElementById('status-msg');
      el.innerText = text;
      el.className = 'status-msg'; 
      if(type === 'error') el.classList.add('text-error');
      if(type === 'success') el.classList.add('text-success');
    }

    // CENTRALIZED REDIRECTION LOGIC
    function enterJarvis(userData, role='verified') {
      console.log("Redirecting to J.A.R.V.I.S...");
      
      // 1. Save Session Data (Persisting user like in your original file)
      localStorage.setItem('jarvis_user', userData.name || "User");
      localStorage.setItem('jarvis_role', role);
      if(userData.email) localStorage.setItem('jarvis_email', userData.email);
      if(userData.picture) localStorage.setItem('jarvis_avatar', userData.picture);
      
      // 2. Visual Feedback
      showMsg("Access Granted. Loading Interface...", "success");

      // 3. Robust Redirect (using window.location.href as per your file)
      setTimeout(() => {
        window.location.href = MAIN_APP_URL;
      }, 700);
    }

    function decodeJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    // ==========================================================
    // 3. AUTHENTICATION LOGIC
    // ==========================================================

    // --- GOOGLE OAUTH ---
    function handleCredentialResponse(response) {
      try {
        const payload = decodeJwt(response.credential);
        showMsg("Verifying Biometrics...", "neutral");

        // Send Welcome Email (Fire and forget, don't wait for it)
        fetch(`${API_URL}/send_welcome`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: payload.name, email: payload.email })
        }).catch(err => console.warn("Email trigger failed:", err));

        // Login immediately
        enterJarvis({
          name: payload.name, 
          email: payload.email, 
          picture: payload.picture
        });

      } catch (err) {
        console.error(err);
        showMsg("Google Auth Failed.", "error");
      }
    }

    // --- EMAIL LOGIN ---
    async function doLogin() {
      const email = document.getElementById('l_email').value;
      const password = document.getElementById('l_pass').value;

      if(!email || !password) return showMsg("Credentials Required", "error");
      showMsg("Authenticating...", "neutral");

      try {
        const res = await fetch(`${API_URL}/login`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email, password})
        });

        if(res.ok) {
          const data = await res.json();
          enterJarvis({ name: data.name, email: email });
        } else {
          showMsg("Access Denied: Invalid Credentials", "error");
        }
      } catch (err) {
        console.error(err);
        showMsg("Server Unreachable. Check Ngrok.", "error");
      }
    }

    // --- REGISTER (Auto-Login included) ---
    async function doRegister() {
      const name = document.getElementById('r_name').value;
      const email = document.getElementById('r_email').value;
      const password = document.getElementById('r_pass').value;

      if(!email || !password) return showMsg("All fields are required", "error");
      showMsg("Creating Identity...", "neutral");

      try {
        const res = await fetch(`${API_URL}/register`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({name, email, password})
        });

        if(res.ok) {
          enterJarvis({ name: name, email: email });
        } else {
          showMsg("Registration Failed. Email used?", "error");
        }
      } catch (err) {
        console.error(err);
        showMsg("Connection Error", "error");
      }
    }

    // --- GUEST MODE (Restored from your file) ---
    function handleGuestMode() {
        showMsg("Initializing Guest Protocols...", "success");
        setTimeout(() => {
            localStorage.setItem('jarvis_user', 'Guest User');
            localStorage.setItem('jarvis_role', 'guest');
            localStorage.removeItem('jarvis_avatar');
            window.location.href = MAIN_APP_URL;
        }, 500);
    }

    // --- PASSWORD RECOVERY ---
    let recoveryEmail = ""; 
    
    async function requestReset() {
      recoveryEmail = document.getElementById('f_email').value;
      if(!recoveryEmail) return showMsg("Email required", "error");
      showMsg("Contacting Server...", "neutral");
      
      try {
        await fetch(`${API_URL}/forgot-password`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email: recoveryEmail})
        });
        switchView('reset');
        showMsg("Code sent to inbox.", "success");
      } catch (err) {
        showMsg("Network Error", "error");
      }
    }

    async function confirmReset() {
      const code = document.getElementById('rs_code').value;
      const new_password = document.getElementById('rs_pass').value;
      if(!code || !new_password) return showMsg("Missing Data", "error");

      try {
        const res = await fetch(`${API_URL}/reset-password`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email: recoveryEmail, code, new_password})
        });

        if(res.ok) {
          showMsg("Password Updated. Logging in...", "success");
          setTimeout(() => switchView('login'), 1500); 
        } else {
          showMsg("Invalid Code.", "error");
        }
      } catch (err) {
        showMsg("Update Failed", "error");
      }
    }
  </script>
</body>
</html>
